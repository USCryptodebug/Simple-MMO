<!DOCTYPE html>
<html>
<head>
  
  <meta charset="utf-8" />
  <title>Firebase Political MMO ‚Äî Trading Fix</title>
  <style>
body {
  font-family: sans-serif;
  color: #eee;
  padding: 12px;

  /* Background image */
  background-image: url("map.jpg");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
}
.col { display:flex; gap:12px; }
.box { background:#1a1a1a; padding:12px; border-radius:6px; flex:1; min-width:260px; }
input,button,select { padding:8px; margin:6px 0; width:100%; box-sizing:border-box; }
#nations, #messages, #tradeList { height:200px; overflow:auto; border:1px solid #333; padding:8px; background:#0f0f0f; }
h1 { color:#ffd54f; margin:0 0 12px 0; }
.small { font-size:0.9rem; color:#aaa; }
.tradeRow { margin-bottom:8px; padding-bottom:6px; border-bottom:1px solid #222; }
ul#myNationResources { margin: 0; padding-left: 18px; }
  </style>
  
</head>
<body>
  <h1>üåç Firebase Political MMO ‚Äî Trading</h1>

  <!-- AUTH -->
  <div class="box" id="authUI">
    <h3>Login / Register</h3>
    <input type="email" id="emailInput" placeholder="Email">
    <input type="password" id="passwordInput" placeholder="Password">
    <button onclick="register()">Register</button>
    <button onclick="login()">Login</button>
    <p class="small" id="authStatus">Not logged in</p>
  </div>

  <!-- GAME UI (hidden until login) -->
  <div id="gameUI" style="display:none; margin-top:12px;">
    <div class="col">
      <div class="box">
        <h3>Your Nation</h3>
        <div id="nationSetup">
          <input id="nationNameInput" placeholder="Enter your nation's name">
          <button onclick="createNation()">Create Nation</button>
        </div>
        <div id="myNationContainer" style="display:none;">
          <p><b id="myNationName"></b></p>
          <p>Population: <span id="myNationPop"></span></p>
          <p>Stability: <span id="myNationStab"></span></p>
          <p>Resources:</p>
          <ul id="myNationResources"></ul>
          <button onclick="collectTaxes()">üí∞ Collect Taxes (+10 gold, -5 stability)</button>
          <button onclick="boostWelfare()">‚ù§Ô∏è Boost Welfare (+5 stability, -12 gold)</button>
          <button onclick="recruitMilitary()">ü™ñ Recruit Military (+10 military, -3 gold)</button>
          <button onclick="buildResource()">üèóÔ∏è Harvest Wood (+10 wood, -5 gold)</button>
        </div>
        <h4>All Nations</h4>
        <div id="nations"></div>
      </div>

      <div class="box">
        <h3>World Chat</h3>
        <div id="messages"></div>
        <input id="msgInput" placeholder="Say something...">
        <button onclick="sendMessage()">Send</button>

        <h3 style="margin-top:12px">Economy / Trades (Create Offer)</h3>

        <!-- Offer: resource type + amount -->
        <label class="small">Offer (give)</label>
        <select id="offerType">
          <option value="gold">gold</option>
          <option value="military">military</option>
          <option value="wood">wood</option>
          <option value="iron">iron</option>
          <option value="oil">oil</option>
          <option value="uranium">uranium</option>
        </select>
        <input id="offerAmount" type="number" placeholder="Offer amount">

        <!-- Want: resource type + amount -->
        <label class="small">Want (receive)</label>
        <select id="wantType">
          <option value="gold">gold</option>
          <option value="military">military</option>
          <option value="wood">wood</option>
          <option value="iron">iron</option>
          <option value="oil">oil</option>
          <option value="uranium">uranium</option>
        </select>
        <input id="wantAmount" type="number" placeholder="Want amount">

        <button onclick="postTrade()">Post Offer</button>
        <p class="small">Posting an offer subtracts your offered resource immediately (prevents double-spend).</p>
      </div>
    </div>

    <div style="margin-top:12px" class="box">
      <h3>Trade Board</h3>
      <div id="tradeList"></div>
      <p class="small">Click Accept to take an offer (resources will be transferred atomically).</p>
    </div>
  </div>

  <!-- Firebase v8 (compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // === Firebase config - your project (you provided earlier) ===
    const firebaseConfig = {
      apiKey: "AIzaSyBAJVns_sxQgyTIv6Psom0zfBfq556L8Fk",
      authDomain: "simple-mmo-f0584.firebaseapp.com",
      databaseURL: "https://simple-mmo-f0584-default-rtdb.firebaseio.com",
      projectId: "simple-mmo-f0584",
      storageBucket: "simple-mmo-f0584.firebasestorage.app",
      messagingSenderId: "428789480488",
      appId: "1:428789480488:web:6172fd10f5088c068fc91d"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const nationsRef = db.ref('nations');
    const messagesRef = db.ref('messages');
    const tradesRef = db.ref('economy'); // trades stored under /economy/{tradeId}

    let myUid = null;
    let myNationName = null;

    // ---------- AUTH ----------
    function register() {
      const email = document.getElementById('emailInput').value;
      const pw = document.getElementById('passwordInput').value;
      if (!email || !pw) return alert('Enter email and password');
      firebase.auth().createUserWithEmailAndPassword(email, pw)
        .catch(e => alert('Register error: ' + e.message));
    }

    function login() {
      const email = document.getElementById('emailInput').value;
      const pw = document.getElementById('passwordInput').value;
      if (!email || !pw) return alert('Enter email and password');
      firebase.auth().signInWithEmailAndPassword(email, pw)
        .catch(e => alert('Login error: ' + e.message));
    }

    function logout() {
      firebase.auth().signOut();
    }

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        myUid = user.uid;
        document.getElementById('authStatus').innerText = 'Logged in as ' + (user.email || user.uid);
        document.getElementById('authUI').style.display = 'none';
        document.getElementById('gameUI').style.display = 'block';
        // check if user already has a nation
        nationsRef.child(myUid).once('value', snap => {
          if (snap.exists()) {
            myNationName = snap.val().name;
            document.getElementById('nationSetup').style.display = 'none';
            document.getElementById('myNationContainer').style.display = 'block';
            updateMyNationDisplay(snap.val());
          } else {
            document.getElementById('nationSetup').style.display = 'block';
            document.getElementById('myNationContainer').style.display = 'none';
          }
        });
      } else {
        myUid = null;
        myNationName = null;
        document.getElementById('authStatus').innerText = 'Not logged in';
        document.getElementById('authUI').style.display = 'block';
        document.getElementById('gameUI').style.display = 'none';
      }
    });

    function recruitMilitary() {
  if (!myUid) return alert('Not logged in');
  const ref = nationsRef.child(myUid);

  ref.once('value', snap => {
    const n = snap.val();
    if (!n) return alert('You have no nation yet');

    if (typeof n.resources === 'number') n.resources = { gold: n.resources };
    if (!n.resources || typeof n.resources !== 'object') n.resources = {};

    if ((n.resources.gold || 0) < 3) return alert('Not enough gold to recruit military');
    n.resources.gold -= 3;
    n.resources.military = (n.resources.military || 0) + 10;

    ref.set(n);
  });
}

function buildResource() {
  if (!myUid) return alert('Not logged in');
  const ref = nationsRef.child(myUid);

  ref.once('value', snap => {
    const n = snap.val();
    if (!n) return alert('You have no nation yet');

    if (typeof n.resources === 'number') n.resources = { gold: n.resources };
    if (!n.resources || typeof n.resources !== 'object') n.resources = {};

    if ((n.resources.gold || 0) < 5) return alert('Not enough gold to harvest wood');
    n.resources.gold -= 5;
    n.resources.wood = (n.resources.wood || 0) + 10;

    ref.set(n);
  });
}


    
    function collectTaxes() {
  if (!myUid) return alert('Not logged in');
  const ref = nationsRef.child(myUid);

  ref.once('value', snap => {
    const n = snap.val();
    if (!n) return alert('You have no nation yet');

    if (typeof n.resources === 'number') n.resources = { gold: n.resources };
    if (!n.resources || typeof n.resources !== 'object') n.resources = {};

    // --- Base effect ---
    n.resources.gold = (n.resources.gold || 0) + 10;
    n.stability = (n.stability || 0) - 5;

    // --- Population change based on stability ---
    if (n.stability >= 60) n.population += 2;
    else if (n.stability <= 30) n.population = Math.max(0, n.population - 2);

    // --- Military recruitment: 10% of collected gold converts to military ---
    const newMilitary = Math.floor(10 * 0.1);
    n.resources.military = (n.resources.military || 0) + newMilitary;

    // --- Random event: 10% chance of revolt ---
    if (Math.random() < 0.1) {
      const revoltLoss = Math.min(n.population, 5);
      n.population -= revoltLoss;
      n.stability = Math.max(0, n.stability - 10);
      messagesRef.push({
        uid: myUid,
        name: n.name,
        text: `‚ö†Ô∏è A small revolt occurred! Lost ${revoltLoss} population and -10 stability.`,
        t: Date.now()
      });
    }

    ref.set(n);
  });
}

function boostWelfare() {
  if (!myUid) return alert('Not logged in');
  const ref = nationsRef.child(myUid);

  ref.once('value', snap => {
    const n = snap.val();
    if (!n) return alert('You have no nation yet');

    if (typeof n.resources === 'number') n.resources = { gold: n.resources };
    if (!n.resources || typeof n.resources !== 'object') n.resources = {};

    // --- Base effect ---
    n.stability = (n.stability || 0) + 5;
    n.resources.gold = (n.resources.gold || 0) - 5;

    // --- Population growth bonus ---
    if (n.stability >= 70) n.population += 2;
    else if (n.stability <= 30) n.population = Math.max(0, n.population - 1);

    // --- Random resource bonus: 10% chance to gain +5 of a random resource ---
    if (Math.random() < 0.1) {
      const resourceTypes = ['wood','iron','oil','uranium'];
      const r = resourceTypes[Math.floor(Math.random() * resourceTypes.length)];
      n.resources[r] = (n.resources[r] || 0) + 5;
      messagesRef.push({
        uid: myUid,
        name: n.name,
        text: `‚ú® Your welfare program discovered extra ${r}! +5 ${r}.`,
        t: Date.now()
      });
    }

    ref.set(n);
  });
}


    // ---------- NATION CREATION (seed full resources) ----------
    function createNation() {
      const name = document.getElementById('nationNameInput').value.trim();
      if (!name) return alert('Enter a nation name');

      const name_lc = name.toLowerCase();

      // check uniqueness using orderByChild('name_lc').equalTo(name_lc)
      nationsRef.orderByChild('name_lc').equalTo(name_lc).once('value', snapshot => {
        if (snapshot.exists()) {
          alert('That nation name is already taken (case-insensitive). Choose another.');
          return;
        }

        const init = {
          name: name,
          name_lc: name_lc,
          population: 100,
          resources: {
            gold: 100,
            military: 500,
            wood: 200,
            iron: 10,
            oil: 10,
            uranium: 0
          },
          stability: 70,
          ownerUid: myUid
        };

        nationsRef.child(myUid).set(init, err => {
          if (err) alert('Error creating nation: ' + err.message);
          else {
            myNationName = name;
            document.getElementById('nationSetup').style.display = 'none';
            document.getElementById('myNationContainer').style.display = 'block';
            updateMyNationDisplay(init);
          }
        });
      });
    }

    // ---------- DISPLAY (safe, supports legacy numeric resources) ----------
    function updateMyNationDisplay(n) {
      const nameEl = document.getElementById('myNationName');
      const popEl = document.getElementById('myNationPop');
      const stabEl = document.getElementById('myNationStab');
      const resList = document.getElementById('myNationResources');

      nameEl.innerText = (n && n.name) ? n.name : '';
      popEl.innerText = (n && typeof n.population !== 'undefined') ? n.population : '';
      stabEl.innerText = (n && typeof n.stability !== 'undefined') ? n.stability : '';

      resList.innerHTML = '';

      // normalize resources: support legacy number -> gold, or object map
      let resources = {};
      if (n) {
        if (typeof n.resources === 'number') {
          resources = { gold: n.resources };
        } else if (n.resources && typeof n.resources === 'object') {
          resources = n.resources;
        }
      }

      if (Object.keys(resources).length > 0) {
        for (const type in resources) {
          if (!Object.prototype.hasOwnProperty.call(resources, type)) continue;
          const li = document.createElement('li');
          li.textContent = `${type}: ${resources[type]}`;
          resList.appendChild(li);
        }
      } else {
        const li = document.createElement('li');
        li.textContent = 'No resources';
        resList.appendChild(li);
      }
    }

    // display all nations live (safe resource formatting)
    nationsRef.on('value', snap => {
      const data = snap.val() || {};
      const out = [];
      for (const uid in data) {
        const n = data[uid];
        let resText = '';
        if (typeof n.resources === 'number') {
          resText = `gold:${n.resources}`;
        } else if (n.resources && typeof n.resources === 'object') {
          resText = Object.entries(n.resources).map(([k,v]) => `${k}:${v}`).join(', ');
        }
        out.push(`<div>${n.name} | Pop:${n.population} | Res:[${resText}] | Stability:${n.stability}</div>`);
        if (uid === myUid) {
          myNationName = n.name;
          updateMyNationDisplay(n);
          document.getElementById('nationSetup').style.display = 'none';
          document.getElementById('myNationContainer').style.display = 'block';
        }
      }
      document.getElementById('nations').innerHTML = out.join('');
    });

    // ---------- NATION ACTIONS (normalize resources) ----------
    function collectTaxes() {
      if (!myUid) return alert('Not logged in');
      const ref = nationsRef.child(myUid);
      ref.once('value', snap => {
        const n = snap.val();
        if (!n) return alert('You have no nation yet');

        if (typeof n.resources === 'number') n.resources = { gold: n.resources };
        if (!n.resources || typeof n.resources !== 'object') n.resources = {};

        n.resources.gold = (n.resources.gold || 0) + 10;
        n.stability = (n.stability || 0) - 5;
        ref.set(n);
      });
    }
    function boostWelfare() {
      if (!myUid) return alert('Not logged in');
      const ref = nationsRef.child(myUid);
      ref.once('value', snap => {
        const n = snap.val();
        if (!n) return alert('You have no nation yet');

        if (typeof n.resources === 'number') n.resources = { gold: n.resources };
        if (!n.resources || typeof n.resources !== 'object') n.resources = {};

        n.stability = (n.stability || 0) + 5;
        n.resources.gold = (n.resources.gold || 0) - 5;
        ref.set(n);
      });
    }

    // ---------- CHAT ----------
    function sendMessage() {
      if (!myUid) return alert('Login required to chat');
      const text = document.getElementById('msgInput').value.trim();
      if (!text) return;
      const name = myNationName || 'Unknown';
      messagesRef.push({ uid: myUid, name: name, text: text, t: Date.now() });
      document.getElementById('msgInput').value = '';
    }
    messagesRef.limitToLast(200).on('child_added', snap => {
      const m = snap.val();
      const div = document.createElement('div');
      div.textContent = `${m.name}: ${m.text}`;
      document.getElementById('messages').appendChild(div);
      document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });

    // ---------- TRADING / ECONOMY (improved multi-resource trades) ----------
    // Post an offer ‚Äî subtract seller's offered resource atomically, then create trade
    function postTrade() {
      if (!myUid) return alert('Login required to post trades');

      const offerType = document.getElementById('offerType').value;
      const offerAmount = parseInt(document.getElementById('offerAmount').value, 10);
      const wantType = document.getElementById('wantType').value;
      const wantAmount = parseInt(document.getElementById('wantAmount').value, 10);

      if (!offerAmount || offerAmount <= 0) return alert('Enter a valid offer amount');
      if (!wantAmount || wantAmount <= 0) return alert('Enter a valid wanted amount');

      const myRef = nationsRef.child(myUid);

      // Subtract offered resource atomically (normalize legacy numeric resources)
      myRef.transaction(curr => {
        if (!curr) return;
        if (typeof curr.resources === 'number') curr.resources = { gold: curr.resources };
        if (!curr.resources || typeof curr.resources !== 'object') curr.resources = {};
        const have = curr.resources[offerType] || 0;
        if (have < offerAmount) return; // abort - insufficient
        curr.resources[offerType] = have - offerAmount;
        return curr;
      }, (err, committed, snap) => {
        if (err) {
          alert('Transaction error: ' + err.message);
          return;
        }
        if (!committed) {
          alert('Not enough ' + offerType + ' to post that offer.');
          return;
        }
        const myNation = snap.val().name || ('uid:' + myUid);
        tradesRef.push({
          fromUid: myUid,
          fromNation: myNation,
          offerType: offerType,
          offerAmount: offerAmount,
          wantType: wantType,
          wantAmount: wantAmount,
          status: 'pending',
          createdAt: Date.now()
        });
      });
    }

    // Accept a trade: mark trade accepted, then perform buyer/seller resource transfers atomically.
    function acceptTrade(tradeId) {
      if (!myUid) return alert('Login required to accept trades');
      const tradeRef = tradesRef.child(tradeId);

      // Step 1: try to mark trade accepted (ensures only one acceptor)
      tradeRef.transaction(tr => {
        if (!tr) return;
        if (tr.status !== 'pending') return; // abort if already taken
        tr.status = 'accepted';
        tr.acceptedByUid = myUid;
        tr.acceptedByNation = myNationName || ('uid:' + myUid);
        tr.acceptedAt = Date.now();
        return tr;
      }, (err, committed, snap) => {
        if (err) {
          alert('Trade transaction failed: ' + err.message);
          return;
        }
        if (!committed) {
          alert('Trade is no longer available (someone else accepted it).');
          return;
        }

        const trade = snap.val();
        const sellerRef = nationsRef.child(trade.fromUid);
        const buyerRef = nationsRef.child(myUid);

        // Step 2: Buyer pays wantAmount of wantType and receives offerAmount of offerType
        buyerRef.transaction(buyer => {
          if (!buyer) return;
          if (typeof buyer.resources === 'number') buyer.resources = { gold: buyer.resources };
          if (!buyer.resources || typeof buyer.resources !== 'object') buyer.resources = {};
          const haveWant = buyer.resources[trade.wantType] || 0;
          if (haveWant < trade.wantAmount) return; // abort if buyer lacks requested resource
          buyer.resources[trade.wantType] = haveWant - trade.wantAmount;
          buyer.resources[trade.offerType] = (buyer.resources[trade.offerType] || 0) + trade.offerAmount;
          return buyer;
        }, (err2, committed2, snap2) => {
          if (err2 || !committed2) {
            // Buyer couldn't pay ‚Äî revert trade to pending
            tradeRef.update({
              status: 'pending',
              acceptedByUid: null,
              acceptedByNation: null,
              acceptedAt: null
            });
            alert('You do not have enough ' + trade.wantType + ' to accept this offer.');
            return;
          }

          // Step 3: Credit seller with the wantAmount of wantType
          sellerRef.transaction(seller => {
            if (!seller) return;
            if (typeof seller.resources === 'number') seller.resources = { gold: seller.resources };
            if (!seller.resources || typeof seller.resources !== 'object') seller.resources = {};
            seller.resources[trade.wantType] = (seller.resources[trade.wantType] || 0) + trade.wantAmount;
            return seller;
          }, (err3) => {
            // If seller credit fails for some reason, attempt to rollback buyer (best-effort)
            if (err3) {
              // attempt rollback buyer: remove received offerAmount, refund wantAmount
              buyerRef.transaction(b => {
                if (!b || !b.resources) return b;
                b.resources[trade.offerType] = (b.resources[trade.offerType] || 0) - trade.offerAmount;
                b.resources[trade.wantType] = (b.resources[trade.wantType] || 0) + trade.wantAmount;
                return b;
              });
              // revert trade to pending
              tradeRef.update({
                status: 'pending',
                acceptedByUid: null,
                acceptedByNation: null,
                acceptedAt: null
              });
              alert('Trade failed while crediting seller; your transaction was rolled back.');
              return;
            }

            // All good ‚Äî record message
            messagesRef.push({
              uid: myUid,
              name: myNationName || 'Unknown',
              text: `accepted ${trade.fromNation}'s offer: gave ${trade.wantAmount} ${trade.wantType}, got ${trade.offerAmount} ${trade.offerType}.`,
              t: Date.now()
            });
          });
        });
      });
    }

    // Show trade list live
    tradesRef.on('value', snap => {
      const out = [];
      snap.forEach(child => {
        const t = child.val();
        const id = child.key;
        if (!t) return;
        if (t.status === 'pending') {
          const showAccept = (t.fromUid !== myUid);
          const acceptBtn = showAccept ? `<button onclick="acceptTrade('${id}')">Accept</button>` : '<span class="small">your offer</span>';
          out.push(`<div class="tradeRow"><b>${t.fromNation}</b> offers <b>${t.offerAmount} ${t.offerType}</b> for <b>${t.wantAmount} ${t.wantType}</b> ‚Äî ${acceptBtn}</div>`);
        } else {
          out.push(`<div class="tradeRow"><b>${t.fromNation}</b> traded ${t.offerAmount} ${t.offerType} for ${t.wantAmount} ${t.wantType} with ${t.acceptedByNation || t.acceptedByUid} (accepted)</div>`);
        }
      });
      document.getElementById('tradeList').innerHTML = out.join('') || '<i>No trades posted.</i>';
    });

    // expose logout for convenience
    window.logout = logout;
  </script>
</body>
</html>








